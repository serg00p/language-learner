<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Тренажер Слів</title>
<style>
body { 
  font-family: Arial, sans-serif; 
  background:#f0f2f5; 
  display:flex; 
  flex-direction:column; 
  justify-content:center; 
  align-items:center; 
  min-height:100vh; 
  margin:0; 
}
#language-buttons, #level-buttons, #mode-buttons { 
  text-align:center; 
  margin:10px 0; 
}
#language-buttons button, #level-buttons button, #article-buttons button, #mode-buttons button { 
  margin:5px; 
  padding:8px 16px; 
  font-size:16px; 
  border:none; 
  border-radius:5px; 
  cursor:pointer; 
  background:#2196F3; 
  color:white; 
}
#language-buttons button.active, #level-buttons button.active, #article-buttons button.selected, #mode-buttons button.active { 
  box-shadow:0 0 10px #666; 
  background-color: #4CAF50;
}
.container { 
  text-align:center; 
  background:#fff; 
  padding:20px; 
  border-radius:10px; 
  box-shadow:0 4px 12px rgba(0,0,0,0.2); 
  width:350px; 
}
#progress-container { 
  width:100%; 
  background:#ddd; 
  border-radius:5px; 
  margin-bottom:10px; 
  height:20px; 
  overflow:hidden; 
}
#progress-bar { 
  height:100%; 
  width:0; 
  background:#4CAF50; 
  border-radius:5px; 
  transition: width 0.3s ease; 
}
.word { 
  font-size:24px; 
  font-weight:bold; 
  margin-bottom:10px; 
}
#word-image { 
  display: block; 
  max-width:100%; 
  max-height:200px; 
  border-radius:8px; 
  margin:0 auto 10px auto; 
}
#article-buttons {
  margin: 10px 0;
  text-align: center;
}
input { 
  font-size:18px; 
  padding:5px; 
  border:2px solid #ccc; 
  border-radius:5px; 
  text-align:center; 
  width:100%; 
  box-sizing:border-box; 
}
button.check { 
  margin-top:10px; 
  padding:10px 20px; 
  font-size:16px; 
  border:none; 
  border-radius:5px; 
  cursor:pointer; 
  background:#4CAF50; 
  color:white; 
}
.popup { 
  display:none; 
  position:fixed; 
  top:50%; 
  left:50%; 
  transform:translate(-50%,-50%); 
  background:white; 
  padding:20px; 
  border-radius:10px; 
  box-shadow:0 4px 8px rgba(0,0,0,0.2); 
  text-align:center; 
  width:300px; 
  z-index:1000; 
}
.popup.correct { 
  border:2px solid #4CAF50; 
}
.popup.wrong { 
  border:2px solid #ff4d4d; 
}
.close-btn { 
  margin-top:10px; 
  padding:5px 10px; 
  border:none; 
  background:#007bff; 
  color:white; 
  border-radius:5px; 
  cursor:pointer; 
}
</style>
</head>
<body>

<div id="language-buttons">
  <button id="english-btn">Англійська</button>
  <button id="german-btn">Німецька</button>
</div>

<div id="mode-buttons">
  <button id="translate-mode">Переклад</button>
  <button id="picture-mode">Зображення</button>
</div>

<div id="level-buttons"></div>

<div class="container">
  <h1>Тренажер Слів</h1>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div class="word" id="word"></div>
  <img id="word-image" alt="Word illustration">

  <div id="article-buttons">
    <button data-article="der">Der</button>
    <button data-article="die">Die</button>
    <button data-article="das">Das</button>
  </div>

  <input type="text" id="answer" maxlength="30" placeholder="Введіть слово">
  <br>
  <button class="check" onclick="checkWord()">Перевірити</button>
</div>

<div id="popup" class="popup">
  <p id="popup-message"></p>
  <button class="close-btn" id="popup-btn">Закрити</button>
</div>

<audio id="correctSound" src="https://www.myinstants.com/media/sounds/correct.mp3"></audio>
<audio id="wrongSound" src="https://www.myinstants.com/media/sounds/wrong.mp3"></audio>

<script>
let allLevels = [];
let currentLevelIndex = null;
let currentLevelWords = [];
let remainingWords = [];
let wrongWords = [];
let currentWord = {};
let currentLanguage = "english";
let selectedArticle = null;
let mode = "translate";
let PEXELS_API_KEY = "";

const languageButtons = {
  english: document.getElementById("english-btn"),
  german: document.getElementById("german-btn")
};
const modeButtons = {
  translate: document.getElementById("translate-mode"),
  picture: document.getElementById("picture-mode")
};
const levelButtonsContainer = document.getElementById("level-buttons");
const articleButtons = Array.from(document.querySelectorAll("#article-buttons button"));
const popup = document.getElementById("popup");
const popupMessage = document.getElementById("popup-message");
const popupBtn = document.getElementById("popup-btn");
const wordDiv = document.getElementById("word");
const wordImg = document.getElementById("word-image");

document.getElementById("answer").addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    try { checkWord(); } catch (e) { console.error(e); alert("Помилка при перевірці слова."); }
  }
});

async function loadConfig() {
  try {
    const res = await fetch("config.json");
    if (!res.ok) throw new Error("Не вдалося завантажити config.json");
    const config = await res.json();
    PEXELS_API_KEY = config.PEXELS_API_KEY || "";
  } catch (e) {
    console.error(e);
    alert("Помилка: не вдалося завантажити API ключ.");
  }
}

async function loadWords(language) {
  try {
    hidePopup();
    currentLanguage = language;
    selectedArticle = null;
    articleButtons.forEach(b => b.classList.remove("selected"));

    const url = language === "english" ? 'english_words.json' : 'german_words.json';
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Не вдалося завантажити ${url}`);
    allLevels = await res.json();

    createLevelButtons();
    highlightLanguageButton();

    currentLevelIndex = null;
    currentLevelWords = [];
    remainingWords = [];
    wrongWords = [];
    currentWord = {};
    wordDiv.innerText = "";
    wordImg.style.display = "none";
    document.getElementById("answer").value = "";
    updateProgressBar();
    updateLevelButtons();
    toggleArticleButtons(false);
  } catch (e) {
    console.error(e);
    alert("Помилка: не вдалося завантажити слова.");
  }
}

function createLevelButtons() {
  try {
    levelButtonsContainer.innerHTML = "";
    allLevels.forEach((lvl, i) => {
      const btn = document.createElement("button");
      btn.textContent = lvl.name;
      btn.onclick = () => selectLevel(i, currentLevelIndex !== i);
      levelButtonsContainer.appendChild(btn);
    });
  } catch (e) { console.error(e); }
}

function highlightLanguageButton() {
  try {
    languageButtons.english.classList.toggle("active", currentLanguage === "english");
    languageButtons.german.classList.toggle("active", currentLanguage === "german");
  } catch (e) { console.error(e); }
}

function highlightModeButton() {
  try {
    modeButtons.translate.classList.toggle("active", mode === "translate");
    modeButtons.picture.classList.toggle("active", mode === "picture");
  } catch (e) { console.error(e); }
}

function selectLevel(index, allowReset = true) {
  try {
    hidePopup();
    if(currentLevelIndex === index && !allowReset) return;
    currentLevelIndex = index;
    currentLevelWords = [...allLevels[index].words];
    remainingWords = [...currentLevelWords];
    wrongWords = [];
    currentWord = {};
    selectedArticle = null;
    articleButtons.forEach(b => b.classList.remove("selected"));
    updateLevelButtons();
    displayNewWord();
    updateProgressBar();
  } catch (e) { console.error("Error selecting level:", e); }
}

function updateLevelButtons() {
  try {
    Array.from(levelButtonsContainer.children).forEach((btn, i) => {
      btn.classList.toggle("active", i === currentLevelIndex);
    });
  } catch (e) { console.error(e); }
}

articleButtons.forEach(b => {
  b.onclick = () => {
    try {
      selectedArticle = b.dataset.article;
      articleButtons.forEach(btn => btn.classList.remove("selected"));
      b.classList.add("selected");
    } catch (e) { console.error(e); }
  };
});

function toggleArticleButtons(show) {
  try {
    document.getElementById("article-buttons").style.display = show ? "block" : "none";
  } catch (e) { console.error(e); }
}

function getNextWord() {
  if (remainingWords.length === 0) return null;
  const index = Math.floor(Math.random() * remainingWords.length);
  return remainingWords[index];
}

async function displayNewWord() {
  try {
    if (remainingWords.length === 0) { showLevelComplete(); return; }
    currentWord = getNextWord();
    document.getElementById("answer").value = "";
    selectedArticle = null;
    articleButtons.forEach(b => b.classList.remove("selected"));
    toggleArticleButtons(currentLanguage === "german" && currentWord.requiresArticle);

    if (mode === "translate") {
      wordDiv.innerText = currentWord.uk;
      wordImg.style.display = "none";
    } else {
      try {
        const query = encodeURIComponent(currentWord.imageQuery || currentWord.uk);
        const res = await fetch(`https://api.pexels.com/v1/search?query=${query}&per_page=1`, {
          headers: { Authorization: PEXELS_API_KEY }
        });
        if(!res.ok) throw new Error("API error");
        const data = await res.json();
        if(data.photos.length > 0){
          wordImg.src = data.photos[0].src.medium;
          wordImg.style.display="block";
          wordDiv.innerText = "";
        } else throw new Error("No image");
      } catch(e){
        console.warn(e);
        wordDiv.innerText = currentWord.uk;
        wordImg.style.display = "none";
        popupMessage.innerText = "Не вдалося завантажити зображення. Перехід у режим перекладу.";
        popup.className = "popup wrong";
        popupBtn.style.display = "inline-block";
        popupBtn.onclick = () => { popup.style.display="none"; mode="translate"; highlightModeButton(); displayNewWord(); };
        popup.style.display = "block";
      }
    }
  } catch(e){ console.error("Error displaying new word:", e); }
}

function updateProgressBar() {
  try {
    const completed = currentLevelWords.length - remainingWords.length;
    const percent = currentLevelWords.length ? (completed/currentLevelWords.length*100) : 0;
    document.getElementById("progress-bar").style.width = percent + "%";
  } catch(e){ console.error(e); }
}

function checkWord() {
  try {
    if(!currentWord) return;
    let userInput = document.getElementById("answer").value.trim().toLowerCase();

    if(currentLanguage === "german") userInput = userInput.replace(/ss/g, "ß");
    if(currentLanguage === "german" && currentWord.requiresArticle && selectedArticle) {
      userInput = selectedArticle + " " + userInput;
    }

    if(userInput === currentWord.en.toLowerCase()) {
      document.getElementById("correctSound").play();
      remainingWords = remainingWords.filter(w => w !== currentWord);
      updateProgressBar();
      popupMessage.innerText = "Правильно!";
      popup.className = "popup correct";
      popupBtn.style.display = "none";
      popup.style.display = "block";
      setTimeout(() => { popup.style.display="none"; displayNewWord(); }, 1200);
    } else {
      document.getElementById("wrongSound").play();
      if(!wrongWords.includes(currentWord.uk)) wrongWords.push(currentWord.uk);
      popupMessage.innerText = `Неправильно! Правильна відповідь: ${currentWord.en}`;
      popup.className = "popup wrong";
      popupBtn.innerText = "Спробувати ще раз";
      popupBtn.style.display = "inline-block";
      popupBtn.onclick = () => { popup.style.display="none"; document.getElementById("answer").value=""; };
      popup.style.display = "block";
    }
  } catch(e){ console.error("Error checking word:", e); alert("Сталася помилка при перевірці слова."); }
}

function showLevelComplete() {
  try {
    popupMessage.innerText = `Рівень "${allLevels[currentLevelIndex].name}" завершено!\n` +
                             (wrongWords.length ? "Повторіть: "+wrongWords.join(", ") : "Всі правильно!");
    popup.className = "popup correct";
    popupBtn.innerText = "Перезапустити рівень";
    popupBtn.style.display = "inline-block";
    popupBtn.onclick = () => { popup.style.display="none"; selectLevel(currentLevelIndex, true); };
    popup.style.display = "block";
  } catch(e){ console.error(e); }
}

function hidePopup() {
  try {
    popup.style.display="none";
    popup.className="popup";
  } catch(e){ console.error(e); }
}

languageButtons.english.onclick = () => loadWords("english");
languageButtons.german.onclick = () => loadWords("german");
modeButtons.translate.onclick = () => { mode="translate"; highlightModeButton(); displayNewWord(); };
modeButtons.picture.onclick = () => { mode="picture"; highlightModeButton(); displayNewWord(); };

window.onload = async () => {
  try {
    await loadConfig();
    await loadWords("english");
    highlightModeButton();
  } catch(e){ console.error(e); alert("Сталася помилка при завантаженні програми."); }
};
</script>

</body>
</html>
