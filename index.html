<script>
  let allWords = [];
  const wordsPerLevel = 5;
  let levels = [];

  let currentLevel = 0;
  let currentLevelWords = [];
  let usedWords = [];
  let wrongWords = [];
  let currentWord = {};

  const levelButtonsContainer = document.getElementById("level-buttons");

  async function loadWords() {
    try {
      const response = await fetch("english_words.json");
      allWords = await response.json();

      // Split into levels
      levels = [];
      for (let i = 0; i < Math.ceil(allWords.length / wordsPerLevel); i++) {
        levels.push(allWords.slice(i * wordsPerLevel, (i + 1) * wordsPerLevel));
      }

      createLevelButtons();
      selectLevel(0);
    } catch (err) {
      console.error("Error loading words:", err);
      document.getElementById("word").innerText = "Failed to load words.";
    }
  }

  function createLevelButtons() {
    levelButtonsContainer.innerHTML = "";
    for (let i = 0; i < levels.length; i++) {
      const btn = document.createElement("button");
      btn.textContent = `Level ${i + 1}`;
      btn.dataset.levelIndex = i;
      btn.onclick = () => { if (currentLevel !== i) selectLevel(i); };
      levelButtonsContainer.appendChild(btn);
    }
  }

  function selectLevel(levelIndex) {
    currentLevel = levelIndex;
    currentLevelWords = levels[currentLevel];
    usedWords = [];
    wrongWords = [];
    updateProgressBar();
    updateActiveLevelButton();
    document.getElementById("popup").style.display = "none";
    displayNewWord();
  }

  function updateActiveLevelButton() {
    const buttons = levelButtonsContainer.children;
    for (let i = 0; i < buttons.length; i++) {
      buttons[i].classList.toggle("active", Number(buttons[i].dataset.levelIndex) === currentLevel);
    }
  }

  function updateProgressBar() {
    document.getElementById("progress-bar").style.width =
      (usedWords.length / currentLevelWords.length) * 100 + "%";
  }

  function getRandomWord() {
    let word;
    do {
      word = currentLevelWords[Math.floor(Math.random() * currentLevelWords.length)];
    } while (usedWords.includes(word));
    usedWords.push(word);
    return word;
  }

  function displayNewWord() {
    updateProgressBar();
    if (usedWords.length >= currentLevelWords.length) {
      showLevelCompleteScreen();
      return;
    }
    currentWord = getRandomWord();
    document.getElementById("word").innerText = currentWord.uk;
    document.getElementById("answer").value = "";
  }

  function checkAndNextWord() {
    const userInput = document.getElementById("answer").value.trim().toLowerCase();
    const popup = document.getElementById("popup");
    const message = document.getElementById("popup-message");

    if (userInput === currentWord.en) {
      message.innerText = "Correct!";
      popup.className = "popup correct";
      document.getElementById("correctSound1").play();
      popup.style.display = "block";
      setTimeout(() => { popup.style.display = "none"; displayNewWord(); }, 1500);
    } else {
      message.innerText = `Wrong! Correct: ${currentWord.en}`;
      popup.className = "popup wrong";
      document.getElementById("wrongSound1").play();
      popup.style.display = "block";
      if (!wrongWords.includes(currentWord.uk)) wrongWords.push(currentWord.uk);
    }
  }

  function closePopup() {
    const popup = document.getElementById("popup");
    popup.style.display = "none";
    popup.className = "popup";
  }

  function showLevelCompleteScreen() {
    const popup = document.getElementById("popup");
    const message = document.getElementById("popup-message");
    let stats = wrongWords.length ? "Review: " + wrongWords.join(", ") : "All correct!";
    message.innerText = `Level ${currentLevel + 1} complete!\n${stats}`;
    popup.className = "popup completed";
    const closeBtn = document.querySelector(".close-btn");
    closeBtn.innerText = "Next Level";
    closeBtn.onclick = () => {
      popup.style.display = "none";
      if (currentLevel < levels.length - 1) selectLevel(currentLevel + 1);
      else selectLevel(0);
    };
    popup.style.display = "block";
    levelButtonsContainer.children[currentLevel].classList.add("completed");
  }

  window.onload = loadWords;
</script>
